#!/bin/zsh

function verbose() {
  if [[ $DOTFILES_VERBOSE_OUTPUT != 0 ]]; then
    echo "${1}"
  fi
}

function import() {
  local file="${1}"

  if [[ ! -f "${file}" ]]; then
    echo "Error: file '${file}' does not exist"
  else
    verbose "üíæ Importing: ${file}"
    source "${file}"
  fi
}

# Checks whether a function exists
function function_exists() {
  if compgen -A function | grep -q "^${1}$"; then
    return 0
  else
    return 1
  fi
}

# Lists dotfile_* functions as commands
function available_dotfile_commands() {
  local prefix="${1:-dotfile_}"
  compgen -A function | grep "^${prefix}" | sed "s/^${prefix}/- /"
}

function available_dotfile_executables() {
  find "${HOME}/.dotfiles" -maxdepth 1 -type f -perm -u+x -exec basename {} \; | awk '{print "- " $0}'
}

# Invokes any existing dotfile_ prefixed function
# Usage: dotfile run setup
function dotfile() {
  local function_name="dotfile_${1}"
  local function_arguments="${*:2}"

  if function_exists "${function_name}"; then
    verbose "Calling function: ${function_name} with argument: ${2}"
    "${function_name}" "${function_arguments}"
  else
    verbose "Error: dotfile command '${1}' does not exist"
    echo "--------------------------------------------"
    echo "Available dotfile commands:"
    available_dotfile_commands
  fi
}

# Runs executable script within ~/.dotfiles
# Usage: dotfile run setup
function dotfile_run() {
  verbose "Invoking dotfile_run $@"
  local script="${HOME}/.dotfiles/${1}"

  if [[ ! -f $script ]]; then
    echo "Error: '${script}' is not an executable file"
    echo "--------------------------------------------"
    echo "Available executable scripts in ~/.dotfiles:"
    available_dotfile_executables
  else
    verbose "Running: ${script}"
    . "${script}"
  fi
}

function dotfile_save() {
  verbose "üè° Applying chezmoi changes"
  chezmoi apply
  verbose "üíæ Sourcing ~/.zshrc"
  source "${HOME}/.zshrc"
}

function dotfile_update() {
  verbose "üè° Updating remote chezmoi changes"
  chezmoi update
  verbose "üíæ Sourcing ~/.zshrc"
  source "${HOME}/.zshrc"
}

function dotfile_edit() {
  verbose "üè° Coming home"
  chezmoi cd
  code .
}
